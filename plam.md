# План разработки (plam.md)

> Примечание: если имелся в виду `plan.md`, можно переименовать по запросу. Пока используем `plam.md`.

## Этап 0 — Подготовка (этот документ)
- [x] Согласовать стек и цели.
- [x] Создать `spec.md` и `plam.md`.
- [ ] Создать `gamebook.md` (после первого кода).

## Этап 1 — Каркас проекта и инфраструктура
- Сборка/инфра:
  - [ ] Инициализация Vite + TypeScript.
  - [ ] Добавить Phaser 3, подключить rexUI (через npm пакеты rex-плагинов).
  - [ ] Подключить Spine-плагин (загрузка плагина, проверка совместимости с Phaser версии).
  - [ ] Настроить Vitest (unit/полу-интеграционные тесты), репорт.
  - [ ] Базовые скрипты npm: `dev`, `build`, `test`, `lint` (опционально).
- Структура каталогов:
  - [ ] Создать каркас `src/game`, `core/manager*`, `modules/*`, `ui/theme`.
  - [ ] Заготовки сцен: `BootScene`, `PreloadScene`, `StarSystemScene`, `UIScene`.
- Конфиги/ресурсы:
  - [ ] Добавить `configs/*.json` с базовыми значениями (см. `spec.md`).
  - [ ] Заглушки процедурных ассетов и AssetManager.
- DoD:
  - Проект собирается и стартует пустой сценой; тесты запускаются; rexUI и Spine подключены.

## Этап 2 — Последовательность загрузки и UI-лоадер
- Сцены:
  - [ ] `BootScene`: чтение конфигов, Scale/камера, подключение плагинов.
  - [ ] `PreloadScene`: загрузка ассетов/плагинов, прогресс-бар через rexUI.
  - [ ] Переход в `StarSystemScene` + параллельный запуск `UIScene`.
- Сохранение старта:
  - [ ] `SaveManager`: localStorage; ключ из `persistence.json`.
  - [ ] Старт в последней сохранённой позиции/курсе; зум камеры восстановлен.
- DoD:
  - Видимый прогресс-бар; корректный старт из сейва.

## Этап 3 — Базовая звёздная система и миникарта
- Звёздная система:
  - [ ] Простейшая орбитальная псевдо-динамика планет (круговые орбиты, угловая скорость).
  - [ ] Размещение POI (с «?») и динамических объектов (конвои).
- Миникарта (rexUI):
  - [ ] Отрисовка в масштабе всей системы; корабль/статические тела/POI.
  - [ ] Учёт тумана (неинтерактивная).
- DoD:
  - Масштабируемая миникарта, корректно отражающая мир.

## Этап 4 — Управление камерой (RTS)
- [ ] Зум колесом; пределы из `settings.json`.
- [ ] Edge-pan по краям экрана; скорость панорамирования из конфигов.
- [ ] Режим слежения за кораблём (сохранение зума).
- DoD:
  - Камера отзывчива, режимы переключаются, параметры берутся из конфигов.

## Этап 5 — Перемещение корабля: планирование и следование
- Pathfinding:
  - [ ] `PathPlanner`: A* на сетке [x, y, heading]; penalize turn; предсказание препятствий.
  - [ ] Учёт ускорения/торможения для прихода с V=0.
  - [ ] Отрисовка линии маршрута.
- Follow:
  - [ ] `PathFollower`: профиль скорости, команды движения, корректная остановка.
  - [ ] ПКМ — установка цели; обновление маршрута.
- Тесты:
  - [ ] Юнит-тесты стоимостей/профиля скорости/краевых случаев.
- DoD:
  - Корабль надёжно доезжает до точки, не задевая препятствия, останавливается ровно в цели.

## Этап 6 — FOV и туман войны + открытие POI
- [ ] `GridFOV` (shadow-casting на сетке), `FogOfWarLayer`.
- [ ] POI: иконка «?» вне FOV; при входе — «Открыта локация: <имя>», замена иконки, запись в сейв.
- [ ] Миникарта: отражение FOV/Fog и статусов POI.
- Тесты:
  - [ ] Проверка корректности FOV; проверка открытия POI и персистентности.
- DoD:
  - Туман правильно скрывает динамику вне видимости; открытые POI сохраняются.

## Этап 7 — Эффекты и боевые заготовки
- [ ] `Effects`: Flash/Shake (rex/камерные эффекты), параметры — из конфигов.
- [ ] `Ship`/`Bullet` базовое поведение (без полноценных боёв).
- Тесты:
  - [ ] Smoke-тесты эффектов и базовых апдейтов.
- DoD:
  - Эффекты доступны для вызова; поведение `Ship`/`Bullet` покрыто простыми тестами.

## Этап 8 — Полировка и документация
- [ ] Обновить `gamebook.md`: механики, конфиги и их влияние.
- [ ] Репасс тестов, статическая проверка типов.
- [ ] Минимальные UX-улучшения HUD.

## Тестовая стратегия
- Vitest:
  - Юниты: математика путей/скоростей, FOV, преобразования координат миникарты.
  - Полу-интеграция: построение маршрута -> генерация команд -> финальная позиция V=0.
  - Моки Phaser/таймеров; heavy rendering вне первых релизов.

## Контуры задач (чек-листы)
- Конфиги JSON:
  - [ ] settings.json
  - [ ] gameplay.json
  - [ ] system.json
  - [ ] assets.json
  - [ ] keybinds.json
  - [ ] modules.json
  - [ ] persistence.json
- Менеджеры:
  - [ ] AssetManager
  - [ ] ConfigManager
  - [ ] SaveManager
  - [ ] CameraManager
  - [ ] InputManager
  - [ ] PathfindingManager
  - [ ] MovementManager
  - [ ] FOVManager
  - [ ] FogManager
  - [ ] DiscoveryManager
  - [ ] MinimapManager
  - [ ] GameMediator
- Модули/сцены/UI:
  - [ ] BootScene / PreloadScene / StarSystemScene / UIScene
  - [ ] UI (rexUI): HUD, Minimap, Loader
  - [ ] Spine-подключение (без контента)

## Соглашения и DoD для задач
- Критерии:
  - Код типобезопасен, покрыт тестами (по возможности ≥ 70% для модульной логики).
  - Параметры/внешнее поведение управляются через `configs/*.json`.
  - UI реализован строго через rexUI.
  - Обновлён `gamebook.md` по завершении этапа.

## Риски и меры
- Производительность FOV/тумана на больших картах → сетка с крупной ячейкой, кэш масок, инкрементальные апдейты.
- Сложность A* с heading → ограничение дискретизации углов, эвристика, отсечка горизонта.
- Spine-плагин совместимость → зафиксировать версии Phaser/плагина, отдельный smoke-тест.

## Следующие шаги (после утверждения плана)
1) Реализовать Этап 1 (каркас) + минимальные тесты.
2) Начать Этап 2 (лоадер/сцены) и подготовить `gamebook.md` (каркас документа).


