# План рефакторинга проекта SpaceFeodal

## 1. Архитектурные изменения

### 1.1. Разделение ответственностей в StarSystemScene

В текущей реализации `StarSystemScene` выполняет слишком много задач: инициализация, управление игровыми объектами, обработка ввода, отрисовка и игровая логика. Необходимо разделить эти обязанности.

- **Вынос логики инициализации**: Перенести код инициализации системы в отдельный сервис `SystemInitializer`, который будет отвечать за создание звезд, планет, станций и других статических объектов.
- **Вынос логики обновления**: Создать сервис `GameUpdateManager`, который будет координировать обновление всех игровых систем (NPC, боевая система, туман войны и т.д.) и регистрировать обработчики `UPDATE`.
- **Вынос логики отрисовки**: Перенести методы отрисовки (`drawStarfield`, `drawAimLine` и т.д.) в отдельные компоненты отрисовки, например, `StarfieldRenderer`, `AimLineRenderer`. Это позволит лучше контролировать процесс отрисовки и упростит тестирование.

### 1.2. Упрощение системы управления NPC

В проекте существует дублирование логики управления NPC между `NPCMovementManager`, `NPCStateManager` и `CombatManager`. Необходимо объединить эту логику.

- **Объединение логики**: Создать единый `NPCManager`, который будет отвечать за все аспекты управления NPC: движение, поведение, состояние, боевые действия. Это упростит архитектуру и уменьшит дублирование кода.
- **Упрощение системы состояний**: Пересмотреть сложную систему состояний в `NPCStateManager`. Возможно, для текущих потребностей проекта достаточно более простой конечной машины состояний.
- **Единая точка управления движением**: Вместо использования `NPCMovementManager` и `MovementManager` для NPC, интегрировать логику движения непосредственно в `NPCManager`, используя `MovementManager` как вспомогательный класс.

### 1.3. Улучшение системы ввода

Логика обработки ввода (правая кнопка мыши, радиальное меню) реализована непосредственно в `StarSystemScene`, что делает код менее модульным.

- **Вынос обработки ввода**: Создать отдельный сервис `InputHandler`, который будет отвечать за обработку всех пользовательских действий: клики, перетаскивание камеры, масштабирование.
- **Модульность радиального меню**: Вынести логику радиального меню в отдельный компонент `RadialMenuHandler`, который будет взаимодействовать с `InputHandler` и `MovementManager`.

## 2. Улучшение структуры кода

### 2.1. Организация компонентов

В проекте отсутствует четкая структура для компонентов. Необходимо ввести более строгую организацию.

- **Создание папки components**: В папке `src` создать подпапку `components`, куда перенести все визуальные компоненты (рендереры, UI-элементы).
- **Группировка сервисов**: Создать папку `services` для всех сервисов (менеджеров), таких как `ConfigManager`, `SaveManager`, `CombatManager` и т.д.
- **Модульность сцен**: Перенести всю логику из `StarSystemScene` в соответствующие сервисы и компоненты, оставив в сцене только координацию.

### 2.2. Управление зависимостями

В текущей реализации компоненты напрямую зависят друг от друга, что затрудняет тестирование и модификацию.

- **Внедрение зависимостей**: Внедрить паттерн Dependency Injection для управления зависимостями между сервисами. Это позволит легко подменять зависимости в тестах и упростит конфигурацию.
- **Интерфейсы для сервисов**: Определить интерфейсы для основных сервисов (`ICombatManager`, `IMovementManager` и т.д.), чтобы уменьшить связность компонентов.

## 3. Улучшение читаемости и поддержки кода

### 3.1. Комментирование кода

В коде практически отсутствуют комментарии, объясняющие сложные алгоритмы или архитектурные решения.

- **Комментарии к алгоритмам**: Добавить комментарии к сложным алгоритмам, например, к системе предсказания положения цели в `getAimedTargetPoint`, к системе приоритетов в `NPCStateManager`.
- **Архитектурные комментарии**: Добавить комментарии, объясняющие архитектурные решения, например, почему выбрана та или иная система состояний, как взаимодействуют различные менеджеры.

### 3.2. Улучшение именования

Некоторые переменные и методы имеют неочевидные имена, что затрудняет понимание кода.

- **Уточнение имен**: Переименовать переменные и методы, чтобы их назначение было более очевидным. Например, `npcSim` в `StarSystemScene` можно переименовать в `npcLazySimulationManager`.
- **Единообразие**: Убедиться, что имена переменных и методов следуют единому стилю по всему проекту.

### 3.3. Удаление неиспользуемого кода

В проекте есть закомментированный код и неиспользуемые методы.

- **Очистка кода**: Удалить все закомментированные фрагменты кода, которые не планируется использовать.
- **Удаление неиспользуемых методов**: Удалить методы, которые больше не используются, например, `getRenderPathPoints` в `MovementManager`.

## 4. Оптимизация производительности

### 4.1. Обработка событий UPDATE

В `StarSystemScene` зарегистрировано множество обработчиков `UPDATE`, что может негативно сказаться на производительности.

- **Консолидация обработчиков**: Объединить несколько обработчиков `UPDATE` в один централизованный обработчик в `GameUpdateManager`, который будет вызывать соответствующие методы обновления для каждой системы.
- **Оптимизация условий**: Проверить, можно ли оптимизировать условия внутри обработчиков, чтобы избежать ненужных вычислений.

### 4.2. Управление объектами

При увеличении количества NPC и объектов на сцене могут возникнуть проблемы с производительностью.

- **Объектный пул**: Внедрить объектный пул для часто создаваемых/уничтожаемых объектов, таких как снаряды и эффекты попадания.
- **Фрустум кulling**: Реализовать отсечение объектов, находящихся вне видимой области камеры, для уменьшения нагрузки на отрисовку.

## 5. Улучшение системы конфигурации

### 5.1. Типизация конфигураций

В `ConfigManager` определены типы для конфигураций, но они не везде используются должным образом.

- **Строгая типизация**: Убедиться, что все конфигурации строго типизированы и используются в коде соответствующим образом.
- **Валидация конфигураций**: Добавить валидацию загружаемых конфигураций на этапе инициализации, чтобы избежать ошибок во время выполнения.

### 5.2. Централизованное управление настройками

Настройки разбросаны по разным конфигурационным файлам.

- **Единый доступ к настройкам**: Создать сервис `SettingsService`, который будет предоставлять централизованный доступ ко всем настройкам игры.
- **Горячая перезагрузка**: Реализовать возможность горячей перезагрузки настроек без перезапуска игры для упрощения настройки и тестирования.

## 6. Улучшение системы сохранений

### 6.1. Расширяемость

Текущая реализация `SaveManager` ограничена только сохранением состояния игрока.

- **Гибкая система сохранений**: Расширить `SaveManager` для поддержки сохранения состояния различных игровых систем (NPC, станции, задания и т.д.).
- **Версионирование сохранений**: Добавить систему версионирования сохранений для обеспечения совместимости при обновлениях игры.

## 7. Улучшение системы ввода

### 7.1. Гибкость

Система ввода жестко привязана к мыши и клавиатуре.

- **Поддержка различных устройств**: Расширить `InputManager` для поддержки других устройств ввода, таких как геймпады.
- **Настраиваемые привязки**: Реализовать систему настраиваемых привязок клавиш/кнопок для улучшения пользовательского опыта.

## 8. Улучшение системы отладки

### 8.1. Инструменты разработчика

В проекте есть некоторые отладочные функции, но их недостаточно.

- **Расширение отладочных возможностей**: Добавить больше инструментов для отладки, таких как визуализация путей NPC, отображение состояний, инструменты для манипуляции объектами в реальном времени.
- **Консоль разработчика**: Реализовать консоль разработчика с возможностью выполнения команд и просмотра состояния игры.

## Заключение

Рефакторинг проекта позволит значительно улучшить его архитектуру, читаемость и поддерживаемость. Основное внимание следует уделить разделению ответственностей, упрощению сложных систем и улучшению структуры кода. Это создаст прочную основу для дальнейшего развития проекта и облегчит добавление новых функций.