# Спецификация проекта SF A2

## 1) Обзор
- **Жанр**: 2D песочница/стратегия (RTS-навигация), браузерная, ПК.
- **Сеттинг**: далёкое феодальное будущее, управление массивным кораблём.
- **Основные USP**:
  - **Браузер**: лёгкий доступ, сборка через Vite.
  - **«Покровитель» (LLM)**: генерация глобального сюжета (модуль-заглушка на старте).
  - **Нарративный мультиплеер**: решения всех игроков влияют на состояние мира.
- **Первые цели**: рабочий прототип перемещения и исследования по звездной системе с открытием энкаунтеров («вопросики»). Физика отключена, управление в духе RTS.

## 2) Технологический стек
- **Phaser 3** — основной 2D-движок (без физического движка; используем кинематику и собственную навигацию).
- **rexUI** — строго для всего UI; дополнительные rex-плагины (shake/flash/инпут/сайзеры и т.п.).
- **Vite** — сборка/Dev-server.
- **Vitest** — автотесты (unit/полу-интеграционные калькуляции).
- **Spine** — подключить плагин сразу, для будущих анимаций (на старте без контента).
- **TypeScript** — строго типизированный код.

## 3) Архитектура и модули
Архитектура модульная: каждый модуль можно включать/отключать без ломки других.

### 3.1 Модули (первичный набор)
- **Перемещение и исследование** (M1)
  - Pathfinding с учётом курса/поворота/ускорения/торможения.
  - PathFollower: следование по вычисленному маршруту.
  - Камера: масштаб, панорамирование по краям экрана, режим слежения.
  - Миникарта: обзор всей системы, отображение корабля, статических тел, POI и тумана.
  - Туман войны: FOV на сетке, открытие POI.
- **Боевая система** (M2, закладка)
  - **Ship**: базовая кинематика корабля (ускорение, торможение, поворотная динамика, без физики).
  - **Bullet**: простая пуля (для будущей боёвки).
  - **Эффекты**: Flash/Shake для корабля/камеры через rex/камерные эффекты.
- **Система процедурных заданий** (M3, закладка)
- **Торговая система** (M4, закладка)
- **Менеджмент корабля** (M5, закладка)
- **Управление собственностью** (M6, закладка)
- **Глобальная карта** (M7, закладка)
- **LLM интеграция** (M8, заглушка на старте)

Каждый модуль имеет публичный API и тесты; подключается через реестр модулей и конфиги.

### 3.2 Каркас каталогов
```
src/
  main.ts                      # Vite entry
  game/
    scenes/
      BootScene.ts
      PreloadScene.ts
      StarSystemScene.ts
      UIScene.ts
    core/
      mediator/GameMediator.ts
      managers/
        AssetManager.ts
        ConfigManager.ts
        SaveManager.ts
        CameraManager.ts
        PathfindingManager.ts
        MovementManager.ts
        FOVManager.ts
        FogManager.ts
        DiscoveryManager.ts
        MinimapManager.ts
        InputManager.ts
      store/MetaStore.ts
    modules/
      navigation-exploration/
        path/PathPlanner.ts
        path/PathFollower.ts
        camera/EdgePanController.ts
      combat/
        Ship.ts
        Bullet.ts
        effects/Effects.ts   # Flash/Shake фасады
      fov/
        GridFOV.ts
        FogOfWarLayer.ts
      ui/
        hud/HUDRoot.ts       # только rexUI компоненты
        minimap/Minimap.ts
      narrative-llm/Stub.ts  # заглушка
    ui/theme/
      typography.ts          # типографика и размеры
      dimensions.ts          # базовые отступы, брейкпоинты
  configs/
    settings.json
    gameplay.json
    system.json
    assets.json
    keybinds.json
    modules.json
    persistence.json
  spine/
    README.md                # инструкции по добавлению .skel/.atlas/.png
```

### 3.3 Менеджеры и медиатор
- **GameMediator**: связывает менеджеры/сцены, маршрутизирует события (shipMoveRequested, poiDiscovered и т.д.).
- **AssetManager**: реестр ассетов, загрузка через Phaser Loader, знание о Spine и rex-плагинах.
- **ConfigManager**: чтение/валидирование JSON-конфигов, предоставление констант.
- **SaveManager**: persistance (localStorage на прототипе), последняя позиция/курс/открытые POI.
- **PathfindingManager**: построение маршрута с учётом курса и ограничений движения.
- **MovementManager**: профиль скорости (ускорение/торможение), доведение до нулевой скорости в целевой точке.
- **FOVManager**: расчёт видимости на сетке.
- **FogManager**: визуал тумана войны, маски/шейпы.
- **DiscoveryManager**: логика открытия POI, события «локация открыта».
- **MinimapManager**: отрисовка/обновление миникарты, учёт тумана.
- **InputManager**: ПК-инпут, ПКМ для маршрута, хоткеи, edge-pan.
- **CameraManager**: масштабирование/слежение/панорамирование.

### 3.4 Store для метаданных
- Простой типобезопасный store (`src/game/core/store/MetaStore.ts`) для метаданных (последняя позиция, открытые POI, настройки UI, флаги модулей). Абстракция над `SaveManager`.

## 4) Конфиги JSON (все — человекочитаемые, валидируем через схемы)

### 4.1 `configs/settings.json`
- Экран: целевое разрешение, масштабирование.
- UI: тема, шрифты, размеры.
- Камера: базовые параметры.
Пример:
```json
{
  "resolution": { "width": 1920, "height": 1080 },
  "scaleMode": "RESIZE",
  "ui": {
    "theme": "dark",
    "fontFamily": "Inter, Arial, sans-serif",
    "baseFontSize": 16,
    "spacing": { "xs": 4, "sm": 8, "md": 12, "lg": 16, "xl": 24 }
  },
  "camera": { "minZoom": 0.3, "maxZoom": 2.0, "edgePanMargin": 24 }
}
```

### 4.2 `configs/gameplay.json`
- Движение корабля: `maxSpeed`, `acceleration`, `deceleration`, `turnRateDegPerSec`.
- Pathfinder: `gridCellSize`, `turnCostK`, `obstaclePadding`, `dynamicPredictionHorizonSec`.
- FOV/Fog: `fovRadiusUnits`, `fovCellSize`, `fogColor`, `fogAlpha`.
Пример:
```json
{
  "movement": {
    "maxSpeed": 600,
    "acceleration": 400,
    "deceleration": 500,
    "turnRateDegPerSec": 90
  },
  "pathfinder": {
    "gridCellSize": 64,
    "turnCostK": 1.6,
    "obstaclePadding": 24,
    "dynamicPredictionHorizonSec": 20
  },
  "fov": {
    "radiusUnits": 1200,
    "cellSize": 64,
    "fogColor": "#0b1020",
    "fogAlpha": 0.55
  }
}
```

### 4.3 `configs/system.json`
- Размер системы (в игровых единицах) и длительные перелёты (~2–3 минуты через всю карту при номинальной скорости).
- Небесные тела и орбиты (псевдо-динамика), точки интереса, динамические объекты.
Пример:
```json
{
  "size": { "width": 24000, "height": 24000 },
  "star": { "x": 12000, "y": 12000 },
  "planets": [
    { "id": "p1", "name": "Aster", "orbit": { "radius": 3000, "angularSpeedDegPerSec": 1.2 } },
    { "id": "p2", "name": "Boreal", "orbit": { "radius": 6000, "angularSpeedDegPerSec": 0.7 } }
  ],
  "poi": [
    { "id": "q1", "name": "Таинственный обломок", "x": 8000, "y": 5000, "discovered": false },
    { "id": "q2", "name": "Неизвестная станция", "x": 15000, "y": 17000, "discovered": false }
  ],
  "dynamicObjects": [
    { "id": "convoy1", "type": "ship", "x": 10000, "y": 10000, "vx": 20, "vy": -10 }
  ]
}
```

### 4.4 `configs/assets.json`
Реестр ассетов/плагинов. На прототипе — процедурные фигуры, rex-плагины, Spine-плагин.
```json
{
  "plugins": {
    "rexUI": true,
    "spine": true
  },
  "procedural": {
    "ship": { "shape": "triangle", "size": 48, "color": "#7fd1f3" },
    "planet": { "shape": "circle", "size": 64, "color": "#8888ff" },
    "poiUnknown": { "shape": "question", "size": 32, "color": "#cccccc" }
  }
}
```

### 4.5 `configs/keybinds.json`
```json
{ "toggleFollow": "F", "zoomIn": "+", "zoomOut": "-" }
```

### 4.6 `configs/modules.json`
```json
{ "navigation": true, "combat": false, "llm": false }
```

### 4.7 `configs/persistence.json`
```json
{ "saveKey": "sf_a2_save_v1" }
```

## 5) Сцены и последовательность загрузки
- **BootScene**: чтение конфигов, инициализация rex-плагинов/Spine, настройка Scale.
- **PreloadScene**: загрузка ассетов; **прогресс-бар через rexUI**; подготовка процедурных фигур.
- **StarSystemScene**: инициализация системы, орбиты, препятствия, корабль, маршруты, FOV/Fog, диспетчер событий.
- **UIScene**: HUD/Minimap через rexUI, управление камерой/режимом слежения.
- **Точка старта**: последняя сохранённая позиция/курс игрока (через `SaveManager`).

## 6) Перемещение и исследование
- **ПКМ**: постановка цели; рисуем предполагаемый маршрут.
- **PathPlanner**:
  - Основан на A* по сетке с состоянием [x, y, heading].
  - Стоимость поворота (penalty), учёт ограниченной скорости поворота `turnRateDegPerSec`.
  - Планирование профиля скорости: разгон/торможение для прихода с V=0 в целевую точку.
  - Учёт динамики препятствий (планеты/объекты по орбитам) через предсказание позиций в пределах горизонта `dynamicPredictionHorizonSec`.
- **PathFollower**:
  - Генерация команд движения с учётом кривизны траектории.
  - Тормозной путь: s = v² / (2·aDecel), строгий выход на V=0 в цели.
- **Без физики**: никакого Matter/Arcade; чистая кинематика.

## 7) Камера
- Масштабирование колесом мыши в пределах [minZoom, maxZoom].
- Панорамирование при касании краёв экрана (edge-pan) + клавиши WASD (опционально).
- Кнопка/хоткей «следовать за кораблём»; сохранение текущего зума.

## 8) Туман войны и FOV
- **FOV**: Tile/сеточный, алгоритм shadow-casting/периметровый (адаптивно к крупным клеткам).
- **Fog**: слой-маска над сценой; учитывает FOV, показывает статичные тела и POI-иконки за пределами FOV как «серые/неактивные».
- **Открытие POI**: при входе в радиус обнаружения — событие «Открыта локация: <имя>», смена «?» на фактический объект, запись в `SaveManager`.

## 9) Миникарта
- Плашка rexUI (Container + Sizer). Масштаб всего мира в миниатюре.
- Отображает корабль, статичные тела, POI, контур FOV/Fog.
- Неинтерактивная на прототипе.

## 10) UI через rexUI и типографика
- Все UI-элементы (прогресс-бар, HUD, уведомления, minimap) — строго через rexUI.
- **`src/ui/theme/typography.ts`**: размеры шрифтов (xs/sm/md/lg/xl), веса, line-height.
- **`src/ui/theme/dimensions.ts`**: отступы, брейкпоинты, рамки, радиусы.

## 11) Эффекты: Flash / Shake
- Flash: мерцание спрайта корабля/объектов через rex или кастомный твийн.
- Shake: тряска камеры/спрайтов при событиях (боёвка).

## 12) Spine
- Подключён плагин; реестр ассетов предусматривает тип `spine`. На прототипе — без контента.

## 13) Asset-сервис
- Единая точка работы с ассетами (процедурные фигуры, плагинные ассеты, потенциальные спрайты/шрифты/Spine).
- API: `register()`, `loadForScene()`, `get(key)`, создание процедурной графики в runtime.

## 14) Сохранения
- LocalStorage (прототип): позиция/курс игрока, зум камеры, открытые POI, базовые настройки. Ключ — из `persistence.json`.

## 15) Масштабирование/адаптация экрана
- Таргет 1920×1080, режим Scale: `RESIZE`.
- UI-лейауты через rexUI Sizers; относительные проценты/минимальные размеры.

## 16) Тестирование (Vitest)
- Юнит-тесты: PathPlanner (стоимость, развороты, профиль скорости), FOV (видимость), Store/SaveManager, DiscoveryManager, Minimap-проекции.
- Полу-интеграционные: проверка построения маршрута и генерации команд PathFollower.
- Заглушки Phaser для headless-тестов; heavy-рендер — вне первого релиза.

## 17) Стандарты кода
- TS-строгая типизация публичных API.
- Ранние выходы, без глубокого вложения.
- Комментарии — только по «почему», не «как».
- Разделение ответственности по менеджерам; сцены тонкие.

## 18) Включение/отключение модулей
- Через `configs/modules.json` и реестр модулей. Компоненты UI читают флаги модулей.

## 19) LLM-модуль (заглушка)
- Папка `modules/narrative-llm/` с интерфейсом `NarrativeProvider` и `NoopProvider`.
- Конфиг отключён по умолчанию.

## 20) Acceptance-критерии v0.1 (прототип)
- Правый клик ставит цель; отображается маршрут.
- Корабль следует по маршруту, приходит в точку с V=0 (учёт разгона/торможения/поворота).
- Миникарта показывает корабль/тела/POI и туман войны.
- FOV и Fog обновляются в реальном времени.
- POI «?» меняются на объект при открытии; всплывает уведомление через rexUI.
- Последняя позиция/курс и зум загружаются при старте игры.

## 21) Связанные документы
- `plam.md` — подробный план реализации и дорожная карта.
- `gamebook.md` — игровой дайджест: механики, параметры конфигов и их влияние. Обновлять по завершении каждого этапа.


